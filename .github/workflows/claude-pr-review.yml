name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt

      - name: Create review script
        run: |
          cat > review.py << 'ENDOFPYTHON'
          import json
          import os
          import requests
          
          # Lire le diff
          with open('pr_diff.txt', 'r') as f:
              diff = f.read()[:30000]
          
          # CrÃ©er le prompt
          prompt = f"""Tu es expert en Next.js, shadcn/ui, Strapi et Shopify.

Analyse cette Pull Request et donne:

1. **RÃ©sumÃ© des changements**
2. **Points positifs** âœ…
3. **ProblÃ¨mes potentiels** âš ï¸ (bugs, anti-patterns Next.js, intÃ©gration Strapi/Shopify, shadcn)
4. **SÃ©curitÃ©** ðŸ”’
5. **Performance** âš¡
6. **Recommandations** ðŸ’¡

Focus: Next.js best practices, Server/Client Components, shadcn/ui, Strapi API, Shopify integration.

Diff:
```
{diff}
```
"""
          
          # Appel API
          response = requests.post(
              'https://api.anthropic.com/v1/messages',
              headers={
                  'x-api-key': os.environ['ANTHROPIC_API_KEY'],
                  'anthropic-version': '2023-06-01',
                  'content-type': 'application/json',
              },
              json={
                  'model': 'claude-sonnet-4-20250514',
                  'max_tokens': 4000,
                  'messages': [{'role': 'user', 'content': prompt}]
              }
          )
          
          # Sauvegarder la rÃ©ponse
          if response.status_code == 200:
              data = response.json()
              review = data['content'][0]['text']
              with open('review.txt', 'w') as f:
                  f.write(review)
              print(f"âœ“ Review saved ({len(review)} chars)")
          else:
              print(f"âœ— API Error: {response.status_code}")
              print(response.text)
              exit(1)
          ENDOFPYTHON

      - name: Run review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python review.py

      - name: Post review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.txt', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ¤– Revue Claude\n\n${review}`
            });